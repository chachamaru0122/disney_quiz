<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãŒã£ããƒ¼ä½œå• ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚¯ã‚¤ã‚º</title>

<style>
body {
  font-family: "Hiragino Maru Gothic ProN", sans-serif;
  background: linear-gradient(180deg, #ffd6e8, #fff3b0);
  text-align: center;
  padding: 20px;
}

h1 {
  color: #ff6f91;
}

button {
  width: 100%;
  padding: 14px;
  margin: 10px 0;
  font-size: 16px;
  border-radius: 30px;
  border: none;
  background: white;
}

.correct { color: #ff6f91; font-weight: bold; }
.wrong { color: #5f6caf; font-weight: bold; }

.hidden { display: none; }

#loading {
  margin-top: 30px;
  color: #ff6f91;
  font-weight: bold;
}
</style>
</head>

<body>

<h1>ğŸ° ãŒã£ããƒ¼ä½œå•ã®ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼å•é¡Œ ğŸ°</h1>

<div id="start">
  <button onclick="startQuiz()">ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<div id="quiz" class="hidden"></div>
<div id="feedback" class="hidden"></div>

<!-- é›†è¨ˆä¸­è¡¨ç¤º -->
<div id="loading" class="hidden">
  <h2>ğŸ“Š çµæœã‚’é›†è¨ˆä¸­â€¦</h2>
  <p id="countdown">å°‘ã€…ãŠå¾…ã¡ãã ã•ã„</p>
</div>

<div id="result" class="hidden"></div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw6V-EN8h-zNgAOKfb5jmr1cHvUOQrWzS6jVQmH8FRmZPy1mzvLD2k-jHHv2XUvl5TI/exec";

const quiz = [
  {
    q: "æ±äº¬ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ãƒ©ãƒ³ãƒ‰ã®ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒ©ãƒ³ã‚¹ã®å»ºç¯‰æ§˜å¼ã¯ï¼Ÿ",
    c: ["ãƒãƒ¥ãƒ¼ãƒ€ãƒ¼æœæ§˜å¼","ã‚¹ãƒãƒ¥ã‚¢ãƒ¼ãƒˆæ§˜å¼","ã‚¸ãƒ§ãƒ¼ã‚¸ç‹æœæ§˜å¼","ãƒ´ã‚£ã‚¯ãƒˆãƒªã‚¢æœæ§˜å¼"],
    a: 3
  },
  {
    q: "ç¾å¥³ã¨é‡ç£ã®ãŠåŸã®ç…™çªã®å…ˆã«ã‚ã‚‹å½«åˆ»ã¯ï¼Ÿ",
    c: ["é³©","é¶´","æ¢Ÿ","é¾"],
    a: 0
  },
  {
    q: "ãƒ‡ã‚£ã‚ºãƒ‹ãƒ¼ã‚·ãƒ¼20å‘¨å¹´ãƒŸãƒƒã‚­ãƒ¼å‹ãƒ‰ãƒ¼ãƒŠãƒ„ã®ä¸­èº«ã¯ï¼Ÿ",
    c: ["ã‚¢ãƒƒãƒ—ãƒ«","ã‚ªãƒ¬ãƒ³ã‚¸","ãƒ”ãƒ¼ãƒ","ãƒ¡ãƒ­ãƒ³"],
    a: 2
  }
];

let current = 0;
let answers = [];

function startQuiz() {
  document.getElementById("start").classList.add("hidden");
  document.getElementById("quiz").classList.remove("hidden");
  showQuestion();
}

function showQuestion() {
  const q = quiz[current];
  let html = `<h2>${q.q}</h2>`;
  q.c.forEach((c,i)=>{
    html += `<button onclick="selectAnswer(${i})">${c}</button>`;
  });
  document.getElementById("quiz").innerHTML = html;
}

function selectAnswer(i) {
  const correct = quiz[current].a;
  answers[current] = (i === correct);

  document.getElementById("quiz").classList.add("hidden");
  document.getElementById("feedback").classList.remove("hidden");

  document.getElementById("feedback").innerHTML = `
    <p class="${i === correct ? 'correct' : 'wrong'}">
      ${i === correct ? 'â­• æ­£è§£ï¼' : 'âŒ ä¸æ­£è§£'}
    </p>
    <p>æ­£è§£ï¼š${quiz[current].c[correct]}</p>
    <button onclick="nextQuestion()">æ¬¡ã¸</button>
  `;
}

function nextQuestion() {
  current++;
  document.getElementById("feedback").classList.add("hidden");

  if (current < quiz.length) {
    document.getElementById("quiz").classList.remove("hidden");
    showQuestion();
  } else {
    sendResult();
  }
}

function sendResult() {
  const score = answers.filter(a => a).length;

  // é›†è¨ˆä¸­è¡¨ç¤º
  document.getElementById("loading").classList.remove("hidden");

  let seconds = 3;
  const countdownEl = document.getElementById("countdown");
  countdownEl.textContent = `çµæœè¡¨ç¤ºã¾ã§ ${seconds} ç§’â€¦`;

  const timer = setInterval(() => {
    seconds--;
    if (seconds > 0) {
      countdownEl.textContent = `çµæœè¡¨ç¤ºã¾ã§ ${seconds} ç§’â€¦`;
    }
  }, 1000);

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      score,
      q1: answers[0],
      q2: answers[1],
      q3: answers[2]
    })
  }).then(() => {
    clearInterval(timer);
    showResult();
  });
}

function showResult() {
  document.getElementById("loading").classList.add("hidden");

  fetch(SCRIPT_URL)
    .then(res => res.json())
    .then(data => {

      const myResults = answers.map(a => a ? "â­•" : "âŒ");
      const myScore = answers.filter(a => a).length;
      const total = data.totalUsers || 0;

      const rates = data.correct.map(c =>
        total > 0 ? Math.round((c / total) * 100) : 0
      );

      document.getElementById("result").classList.remove("hidden");

      document.getElementById("result").innerHTML = `
        <h2>ğŸ€ çµæœ ğŸ€</h2>

        <h3>ã‚ãªãŸã®çµæœ</h3>
        <ul style="list-style:none; padding:0;">
          <li>Q1ï¼š${myResults[0]}</li>
          <li>Q2ï¼š${myResults[1]}</li>
          <li>Q3ï¼š${myResults[2]}</li>
        </ul>

        <p><strong>æ­£ç­”æ•°ï¼š</strong>${myScore} / 3</p>

        <hr>

        <h3>ã¿ã‚“ãªã®çµæœ</h3>
        <p>ğŸ‘¤ è§£ã„ãŸäººæ•°ï¼š${total} äºº</p>

        <ul style="list-style:none; padding:0;">
          <li>Q1 æ­£ç­”ç‡ï¼š${rates[0]}%</li>
          <li>Q2 æ­£ç­”ç‡ï¼š${rates[1]}%</li>
          <li>Q3 æ­£ç­”ç‡ï¼š${rates[2]}%</li>
        </ul>
      `;
    })
    .catch(err => {
      document.getElementById("result").classList.remove("hidden");
      document.getElementById("result").innerHTML = `
        <h2>âš ï¸ çµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</h2>
        <p>Apps Script ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¦ã„ã¾ã™</p>
      `;
      console.error(err);
    });
}
</script>

</body>
</html>
